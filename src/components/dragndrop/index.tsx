import * as React from "react";
import { useState } from "react";
import { Icon } from "rsuite";
import { find } from "../../layers/filesystem";

import "./dragndrop.css";

const ACTIVE_CLASS = "dragndrop dragged";
const INACTIVE_CLASS = "dragndrop";

interface IProps {
	handleFiles: (file: string[]) => void;
	handleNoApiKey: () => void;
	apiKey: string;
	loading: boolean;
}

export default ({ handleFiles, handleNoApiKey, apiKey, loading }: IProps) => {
	const [className, setClassName] = useState(INACTIVE_CLASS);

	const _activate = () => setClassName(ACTIVE_CLASS);
	const _deactivate = () => setClassName(INACTIVE_CLASS);

	const onDragEnter = (e) => {
		e.preventDefault();
		_activate();
	};

	const onDragOver = (e) => {
		e.preventDefault();
	};

	const onDragLeave = (e) => {
		e.preventDefault();
		_deactivate();
	};

	const onDragEnd = (e) => {
		e.preventDefault();
	};

	const onDrop = (e) => {
		e.preventDefault();
		_deactivate();

		if (!apiKey) {
			return handleNoApiKey();
		}

		if (e.dataTransfer.files.length) {
			const files: string[] = [];
			const p: Promise<any>[] = [];

			for (let i = 0; i < e.dataTransfer.files.length; i++) {
				const file = e.dataTransfer.files[i];
				if (e.dataTransfer.items[i].webkitGetAsEntry().isDirectory) {
					p.push(find(".pdf", file.path));
				} else {
					if (file.path.toLowerCase().endsWith(".pdf")) {
						p.push(Promise.resolve([file.path]));
					}
				}
			}

			Promise.all(p)
				.then((res) => {
					if (res.length) {
						res.map((p) => files.push(...p));
					}

					return files;
				})
				.then(handleFiles);
		}
	};

	return loading ? (
		<div className={className}>
			<div className="dragndrop-loading-indicator">
				<Icon icon="hourglass-2" size="4x" spin />
			</div>
			<p>Uploading</p>
		</div>
	) : (
		<div
			className={className}
			onDrop={onDrop}
			onDragEnter={onDragEnter}
			onDragOver={onDragOver}
			onDragLeave={onDragLeave}
			onDragEnd={onDragEnd}
		>
			<div className="nk-circle-animation">
				<Icon icon="file-upload" size="4x" />
			</div>
			<p>Click or Drag files to this area to upload</p>
		</div>
	);
};
