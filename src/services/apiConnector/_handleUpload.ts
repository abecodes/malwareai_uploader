import { Dispatch, SetStateAction } from "react";
import db from "../../layers/db";

export default async function (
	f: IFile,
	size: number,
	setFiles: Dispatch<SetStateAction<IFile[]>>,
	setRequests: Dispatch<SetStateAction<number>>,
	remainingRequests: number
) {
	try {
		const file = await db.setFile(
			f.id,
			f.path,
			f.result,
			f.readyAt,
			parseFloat((size / 1024 / 1024).toFixed(2))
		);
		await db.updateLastRequest(Date.now());
		await db.updateRemainingRequests(--remainingRequests);

		setFiles((current) => [
			...current,
			{
				id: file.id,
				path: file.path,
				fileName: file.fileName,
				fileExtension: file.fileExtension,
				readyAt: file.readyAt,
				result: file.result,
				size: file.size,
			},
		]);
		setRequests(--remainingRequests);
	} catch (error) {
		throw error;
	}
}
