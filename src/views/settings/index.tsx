import * as React from "react";

import Form from "../../components/form";
import api from "../../layers/api";
import db from "../../layers/db";

import { StoreContext } from "../../store";
import _getInfoFromHead from "../../utils/_getInfoFromHead";
import "./settings.css";

export default () => (
	<div id="settings">
		<StoreContext.Consumer>
			{({
				apiKey: [apiKey, setApiKey],
				bandwidth: [bandwidth, setBandwidth],
				requests: [requests, setRequests],
				reset: [reset, setReset],
			}) => (
				<Form<{ apiKey: string; bandwidthLimit: string }>
					fields={[
						{
							label: "API Key",
							name: "apiKey",
							default: apiKey,
							placeholder: "Enter API Key",
							type: "text",
							rules: { required: "Please enter an API key" },
						},
						{
							label: "Bandwidth limit",
							name: "bandwidthLimit",
							type: "slider",
							default: bandwidth + "",
						},
					]}
					onSubmit={(data) => {
						if (data.apiKey === apiKey) return;
						api
							.getStats(data.apiKey)
							.then(_getInfoFromHead)
							.then(({ requests, reset }) => {
								const bw = parseInt(data.bandwidthLimit);

								db.setUser(data.apiKey, requests, reset, Date.now(), bw)
									.then(() => {
										setApiKey(data.apiKey);
										setBandwidth(bw);
										setRequests(requests);
										setReset(reset);
									})
									.catch(console.error);
							});
					}}
				/>
			)}
		</StoreContext.Consumer>
	</div>
);
